# ES Monitor Web 开发文档

## 1. 项目结构

### 1.1 目录说明

```
es-monitor-web-kiro/
├── src/
│   ├── components/          # 通用组件
│   ├── layouts/             # 布局组件
│   ├── pages/               # 页面组件
│   ├── services/            # 服务层（Mock数据）
│   ├── types/               # TypeScript 类型定义
│   ├── constants/           # 常量定义
│   ├── App.tsx              # 应用入口
│   └── main.tsx             # 渲染入口
├── public/                  # 静态资源
├── index.html               # HTML 模板
├── vite.config.ts           # Vite 配置
├── tailwind.config.js       # Tailwind 配置
├── tsconfig.json            # TypeScript 配置
└── package.json             # 项目配置
```

### 1.2 路由配置

**文件位置**：`src/App.tsx`

```typescript
<Routes>
  <Route path="/" element={<MainLayout />}>
    {/* 监控 */}
    <Route index element={<Overview />} />
    <Route path="cluster" element={<Cluster />} />
    <Route path="nodes" element={<Nodes />} />
    <Route path="nodes/:id" element={<NodeDetail />} />
    <Route path="indices" element={<Indices />} />
    <Route path="indices/:name" element={<IndexDetail />} />
    
    {/* 管理 */}
    <Route path="index-manage" element={<IndexManage />} />
    <Route path="workflows" element={<Workflows />} />
    
    {/* 告警 */}
    <Route path="alerts" element={<Alerts />} />
    <Route path="alert-rules" element={<AlertRules />} />
    <Route path="alert-records" element={<AlertRecords />} />
    <Route path="notification-channels" element={<NotificationChannels />} />
    
    {/* 审批 */}
    <Route path="approvals" element={<ApprovalList />} />
    <Route path="approvals/submit" element={<ApprovalSubmit />} />
    <Route path="approvals/:id" element={<ApprovalDetail />} />
    
    {/* 开发工具 */}
    <Route path="dev-tools" element={<DevTools />} />
    <Route path="analyzer" element={<Analyzer />} />
  </Route>
</Routes>
```

---

## 2. 数据结构定义

### 2.1 集群相关类型

**文件位置**：`src/types/elasticsearch.ts`

#### ClusterHealth - 集群健康信息

```typescript
interface ClusterHealth {
  cluster_name: string;           // 集群名称
  status: 'green' | 'yellow' | 'red';  // 健康状态
  timed_out: boolean;             // 是否超时
  number_of_nodes: number;        // 节点总数
  number_of_data_nodes: number;   // 数据节点数
  active_primary_shards: number;  // 活跃主分片数
  active_shards: number;          // 活跃分片总数
  relocating_shards: number;      // 迁移中分片数
  initializing_shards: number;    // 初始化中分片数
  unassigned_shards: number;      // 未分配分片数
  delayed_unassigned_shards: number;
  number_of_pending_tasks: number;
  number_of_in_flight_fetch: number;
  task_max_waiting_in_queue_millis: number;
  active_shards_percent_as_number: number;
}
```

#### ClusterStats - 集群统计信息

```typescript
interface ClusterStats {
  _nodes: { total: number; successful: number; failed: number };
  cluster_name: string;
  cluster_uuid: string;
  timestamp: number;
  status: ClusterHealthStatus;
  indices: ClusterIndicesStats;   // 索引统计
  nodes: ClusterNodesStats;       // 节点统计
}
```

### 2.2 节点相关类型

#### NodeStats - 节点统计信息

```typescript
interface NodeStats {
  name: string;                   // 节点名称
  transport_address: string;      // 传输地址
  host: string;                   // 主机名
  ip: string;                     // IP 地址
  version: string;                // ES 版本
  build_flavor: string;
  build_type: string;
  build_hash: string;
  roles: NodeRole[];              // 节点角色列表
  attributes: Record<string, string>;
  os: NodeOsStats;                // 操作系统统计
  jvm: NodeJvmStats;              // JVM 统计
  process: NodeProcessStats;      // 进程统计
  fs: NodeFsStats;                // 文件系统统计
  transport: NodeTransportStats;  // 传输层统计
  http: NodeHttpStats;            // HTTP 统计
  thread_pool: Record<string, ThreadPoolStats>;  // 线程池
  breakers: Record<string, BreakerStats>;        // 断路器
  indices: NodeIndicesStats;      // 索引统计
  ingest: NodeIngestStats;        // Ingest 统计
}
```

#### NodeRole - 节点角色

```typescript
type NodeRole = 
  | 'master'              // 主节点
  | 'data'                // 数据节点
  | 'data_content'        // 内容数据节点
  | 'data_hot'            // 热数据节点
  | 'data_warm'           // 温数据节点
  | 'data_cold'           // 冷数据节点
  | 'data_frozen'         // 冻结数据节点
  | 'ingest'              // 摄取节点
  | 'ml'                  // 机器学习节点
  | 'remote_cluster_client'
  | 'transform'
  | 'voting_only'
  | 'coordinating_only';  // 协调节点
```

### 2.3 索引相关类型

#### IndexInfo - 索引基本信息

```typescript
interface IndexInfo {
  health: 'green' | 'yellow' | 'red';  // 健康状态
  status: 'open' | 'close';            // 开关状态
  index: string;                       // 索引名称
  uuid: string;                        // UUID
  pri: number;                         // 主分片数
  rep: number;                         // 副本数
  'docs.count': number;                // 文档数
  'docs.deleted': number;              // 已删除文档数
  'store.size': string;                // 总存储大小
  'pri.store.size': string;            // 主分片存储大小
  creation_date?: number;              // 创建时间戳
}
```

### 2.4 告警相关类型

#### AlertRule - 告警规则

```typescript
interface AlertRule {
  id: string;                          // 规则ID
  name: string;                        // 规则名称
  description: string;                 // 描述
  enabled: boolean;                    // 是否启用
  metric: AlertMetricType;             // 监控指标
  operator: AlertOperator;             // 比较操作符
  threshold: number;                   // 阈值
  duration: number;                    // 持续时间（秒）
  severity: AlertSeverity;             // 告警级别
  targets?: string[];                  // 目标节点/索引
  notificationChannels: string[];      // 通知渠道ID列表
  cooldown: number;                    // 冷却时间（秒）
  createdAt: number;
  updatedAt: number;
}
```

#### AlertMetricType - 告警指标类型

```typescript
type AlertMetricType = 
  | 'cluster_health'        // 集群健康
  | 'node_cpu'              // CPU 使用率
  | 'node_heap'             // JVM 堆内存
  | 'node_disk'             // 磁盘使用率
  | 'node_memory'           // 系统内存
  | 'index_docs'            // 索引文档数
  | 'index_size'            // 索引大小
  | 'search_latency'        // 搜索延迟
  | 'indexing_latency'      // 索引延迟
  | 'gc_time'               // GC 时间
  | 'thread_pool_rejected'  // 线程池拒绝
  | 'circuit_breaker_tripped'  // 断路器触发
  | 'unassigned_shards';    // 未分配分片
```

#### AlertRecord - 告警记录

```typescript
interface AlertRecord {
  id: string;
  ruleId: string;                      // 关联规则ID
  ruleName: string;                    // 规则名称
  metric: AlertMetricType;
  severity: AlertSeverity;
  status: AlertStatus;                 // firing | resolved | acknowledged
  message: string;                     // 告警消息
  value: number;                       // 触发值
  threshold: number;                   // 阈值
  target?: string;                     // 触发目标
  firedAt: number;                     // 触发时间
  resolvedAt?: number;                 // 恢复时间
  acknowledgedAt?: number;             // 确认时间
  acknowledgedBy?: string;             // 确认人
  notificationsSent: Array<{           // 通知发送记录
    channelId: string;
    channelType: NotificationChannelType;
    sentAt: number;
    success: boolean;
    error?: string;
  }>;
}
```

#### NotificationChannel - 通知渠道

```typescript
interface NotificationChannel {
  id: string;
  name: string;
  type: NotificationChannelType;       // email | dingtalk | webhook | sms | internal
  enabled: boolean;
  config: NotificationChannelConfig;   // 渠道配置
  createdAt: number;
  updatedAt: number;
}

// 邮件配置
interface EmailChannelConfig {
  type: 'email';
  recipients: string[];                // 收件人列表
  smtpHost?: string;
  smtpPort?: number;
  username?: string;
  password?: string;
  useTls?: boolean;
}

// 钉钉配置
interface DingtalkChannelConfig {
  type: 'dingtalk';
  webhookUrl: string;                  // Webhook URL
  secret?: string;                     // 签名密钥
  atMobiles?: string[];                // @手机号
  atAll?: boolean;                     // @所有人
}

// Webhook 配置
interface WebhookChannelConfig {
  type: 'webhook';
  url: string;
  method: 'GET' | 'POST';
  headers?: Record<string, string>;
  template?: string;                   // 消息模板
}
```

### 2.5 审批相关类型

#### ApprovalRequest - 审批申请

```typescript
interface ApprovalRequest {
  id: string;
  title: string;                       // 申请标题
  type: ApprovalRequestType;           // 申请类型
  status: ApprovalStatus;              // 审批状态
  applicant: string;                   // 申请人
  applicantDept?: string;              // 申请部门
  description: string;                 // 申请说明
  content: ApprovalContent;            // 申请内容
  priority: 'low' | 'normal' | 'high' | 'urgent';
  nodes: ApprovalNode[];               // 审批流程节点
  logs: ApprovalLog[];                 // 审批日志
  notificationChannels: string[];      // 通知渠道
  createdAt: number;
  updatedAt: number;
  completedAt?: number;
}
```

#### ApprovalRequestType - 申请类型

```typescript
type ApprovalRequestType =
  | 'create_index'      // 新建索引
  | 'delete_index'      // 删除索引
  | 'update_mapping'    // 修改映射
  | 'update_settings'   // 修改设置
  | 'create_alias'      // 创建别名
  | 'delete_alias'      // 删除别名
  | 'update_alias'      // 修改别名
  | 'create_template'   // 创建模板
  | 'delete_template'   // 删除模板
  | 'create_pipeline'   // 创建管道
  | 'delete_pipeline'   // 删除管道
  | 'reindex'           // 重建索引
  | 'other';            // 其他
```

#### ApprovalStatus - 审批状态

```typescript
type ApprovalStatus =
  | 'pending'           // 待审批
  | 'approved'          // 已通过
  | 'rejected'          // 已驳回
  | 'cancelled'         // 已取消
  | 'processing'        // 处理中
  | 'completed'         // 已完成
  | 'failed';           // 执行失败
```

#### ApprovalNode - 审批节点

```typescript
interface ApprovalNode {
  id: string;
  name: string;                        // 节点名称
  type: 'approval' | 'notification' | 'execution';
  assignee?: string;                   // 审批人
  assigneeRole?: string;               // 审批角色
  status: 'pending' | 'approved' | 'rejected' | 'skipped';
  comment?: string;                    // 审批意见
  operatedAt?: number;                 // 操作时间
  operatedBy?: string;                 // 操作人
}
```

### 2.6 操作流相关类型

#### AtomicOperation - 原子操作

```typescript
interface AtomicOperation {
  id: string;
  name: string;                        // 操作名称
  type: AtomicOperationType;           // 操作类型
  description: string;                 // 描述
  apiConfig: AtomicOperationApiConfig; // API 配置
  inputSchema: Record<string, unknown>;  // 输入参数定义
  outputSchema?: Record<string, unknown>; // 输出参数定义
  isBuiltin: boolean;                  // 是否内置
  createdAt?: number;
  updatedAt?: number;
}
```

#### AtomicOperationApiConfig - API 配置

```typescript
interface AtomicOperationApiConfig {
  method: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'HEAD';
  endpoint: string;                    // API 端点，支持变量 {{indexName}}
  body?: string;                       // 请求体模板，JSON 格式
  headers?: Record<string, string>;
  successCondition?: string;           // 成功条件表达式
}
```

#### AtomicOperationType - 原子操作类型

```typescript
type AtomicOperationType =
  | 'read_index_config'   // 读取索引配置
  | 'create_index'        // 创建索引
  | 'update_mapping'      // 更新映射
  | 'update_settings'     // 更新设置
  | 'reindex'             // 重建索引
  | 'create_alias'        // 创建别名
  | 'switch_alias'        // 切换别名
  | 'delete_alias'        // 删除别名
  | 'delete_index'        // 删除索引
  | 'verify_data'         // 验证数据
  | 'backup_index'        // 备份索引
  | 'custom_api'          // 自定义 API
  | 'custom_script';      // 自定义脚本
```

#### WorkflowTemplate - 操作流模板

```typescript
interface WorkflowTemplate {
  id: string;
  name: string;
  description: string;
  category: 'index' | 'alias' | 'migration' | 'custom';
  steps: WorkflowStep[];               // 步骤列表
  isBuiltin: boolean;
  boundApprovalTypes?: ApprovalRequestType[];  // 绑定的审批类型
  createdAt: number;
  updatedAt: number;
}
```

#### WorkflowInstance - 操作流实例

```typescript
interface WorkflowInstance {
  id: string;
  templateId?: string;
  templateName?: string;
  name: string;
  description?: string;
  status: WorkflowStatus;
  steps: WorkflowStep[];
  variables: Record<string, unknown>;  // 流程变量
  approvalId?: string;                 // 关联审批ID
  currentStepIndex?: number;
  progress?: number;                   // 0-100
  triggerType?: 'manual' | 'approval';
  createdBy: string;
  createdAt: number;
  updatedAt: number;
  startedAt?: number;
  completedAt?: number;
}
```

#### WorkflowStep - 操作流步骤

```typescript
interface WorkflowStep {
  id: string;
  name: string;
  type: WorkflowStepType;
  description?: string;
  config: Record<string, unknown>;
  status: 'pending' | 'running' | 'completed' | 'failed' | 'skipped';
  result?: WorkflowStepResult;
  startedAt?: number;
  completedAt?: number;
  error?: string;
  retryCount?: number;
  maxRetries?: number;
}

interface WorkflowStepResult {
  success: boolean;
  message?: string;
  data?: Record<string, unknown>;
  duration?: number;                   // 执行耗时(ms)
  response?: unknown;                  // API 响应
}
```

---

## 3. Mock 数据服务

### 3.1 监控数据 (mockData.ts)

**文件位置**：`src/services/mockData.ts`

#### 导出函数

| 函数名 | 返回类型 | 说明 |
|--------|----------|------|
| `generateClusterHealth()` | `ClusterHealth` | 生成集群健康数据 |
| `generateClusterStats()` | `ClusterStats` | 生成集群统计数据 |
| `generateNodeStats()` | `Record<string, NodeStats>` | 生成所有节点统计 |
| `getNodeList()` | `NodeInfo[]` | 获取节点列表 |
| `generateIndexList()` | `IndexInfo[]` | 生成索引列表 |
| `generateIndexStats(indexName)` | `IndexStats` | 生成索引统计 |
| `generateIndexSettings(indexName)` | `IndexSettings` | 生成索引设置 |
| `generateIndexMapping(indexName)` | `IndexMapping` | 生成索引映射 |
| `generateMonitoringOverview()` | `MonitoringOverview` | 生成监控概览 |
| `generateTimeSeries(metric, start, end)` | `TimeSeriesDataPoint[]` | 生成时序数据 |
| `generateNodeTimeSeries(nodeId, metrics)` | `Record<string, TimeSeriesDataPoint[]>` | 生成节点时序 |
| `generateIndexTimeSeries(indexName, metrics)` | `Record<string, TimeSeriesDataPoint[]>` | 生成索引时序 |

#### 使用示例

```typescript
import { 
  generateClusterHealth, 
  generateNodeStats,
  generateTimeSeries 
} from '@/services/mockData';

// 获取集群健康状态
const health = generateClusterHealth();
console.log(health.status); // 'green'

// 获取节点统计
const nodes = generateNodeStats();
Object.entries(nodes).forEach(([id, stats]) => {
  console.log(`${stats.name}: CPU ${stats.os.cpu.percent}%`);
});

// 生成时序数据（最近1小时）
const cpuData = generateTimeSeries(
  'cpu_percent',
  Date.now() - 3600000,
  Date.now()
);
```

### 3.2 告警数据 (alertMockData.ts)

**文件位置**：`src/services/alertMockData.ts`

#### 导出数据

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `mockAlertRules` | `AlertRule[]` | 告警规则列表 |
| `mockAlertRecords` | `AlertRecord[]` | 告警记录列表 |
| `mockNotificationChannels` | `NotificationChannel[]` | 通知渠道列表 |

#### 导出函数

| 函数名 | 返回类型 | 说明 |
|--------|----------|------|
| `generateAlertStatistics()` | `AlertStatistics` | 生成告警统计 |

#### 名称映射

```typescript
// 指标名称
export const ALERT_METRIC_NAMES: Record<AlertMetricType, string> = {
  cluster_health: '集群健康状态',
  node_cpu: 'CPU 使用率',
  node_heap: 'JVM 堆内存',
  // ...
};

// 操作符名称
export const ALERT_OPERATOR_NAMES: Record<string, string> = {
  gt: '大于',
  gte: '大于等于',
  lt: '小于',
  lte: '小于等于',
  eq: '等于',
  neq: '不等于',
};

// 级别名称
export const ALERT_SEVERITY_NAMES: Record<AlertSeverity, string> = {
  critical: '严重',
  warning: '警告',
  info: '信息',
};

// 状态名称
export const ALERT_STATUS_NAMES: Record<AlertStatus, string> = {
  firing: '触发中',
  resolved: '已恢复',
  acknowledged: '已确认',
};

// 渠道类型名称
export const NOTIFICATION_CHANNEL_TYPE_NAMES: Record<string, string> = {
  email: '邮件',
  dingtalk: '钉钉',
  webhook: 'Webhook',
  sms: '短信',
  internal: '站内信',
};
```

### 3.3 审批数据 (approvalMockData.ts)

**文件位置**：`src/services/approvalMockData.ts`

#### 导出数据

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `mockApprovalRequests` | `ApprovalRequest[]` | 审批申请列表 |

#### 名称映射

```typescript
// 申请类型名称
export const APPROVAL_TYPE_NAMES: Record<ApprovalRequestType, string> = {
  create_index: '新建索引',
  delete_index: '删除索引',
  update_mapping: '修改映射',
  update_settings: '修改设置',
  create_alias: '创建别名',
  delete_alias: '删除别名',
  update_alias: '修改别名',
  create_template: '创建模板',
  delete_template: '删除模板',
  create_pipeline: '创建管道',
  delete_pipeline: '删除管道',
  reindex: '重建索引',
  other: '其他操作',
};

// 审批状态名称
export const APPROVAL_STATUS_NAMES: Record<ApprovalStatus, string> = {
  pending: '待审批',
  approved: '已通过',
  rejected: '已驳回',
  cancelled: '已取消',
  processing: '处理中',
  completed: '已完成',
  failed: '执行失败',
};

// 优先级名称
export const APPROVAL_PRIORITY_NAMES: Record<string, string> = {
  low: '低',
  normal: '普通',
  high: '高',
  urgent: '紧急',
};
```

### 3.4 操作流数据 (workflowMockData.ts)

**文件位置**：`src/services/workflowMockData.ts`

#### 导出数据

| 变量名 | 类型 | 说明 |
|--------|------|------|
| `atomicOperations` | `AtomicOperation[]` | 原子操作列表 |
| `builtinWorkflowTemplates` | `WorkflowTemplate[]` | 内置模板列表 |
| `mockWorkflowInstances` | `WorkflowInstance[]` | 操作流实例列表 |
| `mockExecutionRecords` | `WorkflowExecutionRecord[]` | 执行记录列表 |

#### 内置原子操作

| ID | 名称 | 类型 | API 配置 |
|----|------|------|----------|
| op-001 | 读取索引配置 | read_index_config | GET /{{indexName}} |
| op-002 | 创建索引 | create_index | PUT /{{indexName}} |
| op-003 | 数据迁移 | reindex | POST /_reindex |
| op-004 | 切换别名 | switch_alias | POST /_aliases |
| op-005 | 删除索引 | delete_index | DELETE /{{indexName}} |
| op-006 | 验证数据 | verify_data | GET /{{sourceIndex}},{{targetIndex}}/_count |
| op-007 | 创建别名 | create_alias | POST /_aliases |
| op-008 | 备份索引 | backup_index | PUT /_snapshot/{{repository}}/{{snapshotName}} |
| op-009 | 更新映射 | update_mapping | PUT /{{indexName}}/_mapping |
| op-010 | 更新设置 | update_settings | PUT /{{indexName}}/_settings |
| op-011 | 删除别名 | delete_alias | POST /_aliases |

#### 内置操作流模板

| ID | 名称 | 分类 | 步骤数 | 绑定审批 |
|----|------|------|--------|----------|
| tpl-001 | 索引映射变更 | migration | 7 | update_mapping |
| tpl-002 | 新建业务索引 | index | 3 | create_index |
| tpl-003 | 别名切换 | alias | 2 | update_alias |
| tpl-004 | 索引数据迁移 | migration | 4 | reindex |
| tpl-005 | 索引删除（含备份） | index | 3 | delete_index |

#### 名称映射

```typescript
// 原子操作类型名称
export const ATOMIC_OPERATION_NAMES: Record<AtomicOperationType, string> = {
  read_index_config: '读取索引配置',
  create_index: '创建索引',
  update_mapping: '更新映射',
  update_settings: '更新设置',
  reindex: '数据迁移',
  create_alias: '创建别名',
  switch_alias: '切换别名',
  delete_alias: '删除别名',
  delete_index: '删除索引',
  verify_data: '验证数据',
  backup_index: '备份索引',
  custom_api: '自定义API',
  custom_script: '自定义脚本',
};

// HTTP 方法颜色
export const HTTP_METHOD_COLORS: Record<string, string> = {
  GET: 'green',
  POST: 'blue',
  PUT: 'orange',
  DELETE: 'red',
  HEAD: 'purple',
};

// 操作流状态名称
export const WORKFLOW_STATUS_NAMES: Record<string, string> = {
  draft: '草稿',
  pending_approval: '待审批',
  approved: '已审批',
  running: '执行中',
  completed: '已完成',
  failed: '失败',
  cancelled: '已取消',
};

// 分类名称
export const WORKFLOW_CATEGORY_NAMES: Record<string, string> = {
  index: '索引操作',
  alias: '别名操作',
  migration: '数据迁移',
  custom: '自定义',
};

// 审批类型与操作流绑定关系
export const APPROVAL_WORKFLOW_BINDINGS: Record<ApprovalRequestType, string[]> = {
  create_index: ['tpl-002'],
  delete_index: ['tpl-005'],
  update_mapping: ['tpl-001'],
  update_alias: ['tpl-003'],
  reindex: ['tpl-004'],
  // ...其他类型
};
```

---

## 4. 页面组件接口

### 4.1 监控概览 (Overview)

**文件位置**：`src/pages/Overview/index.tsx`

**数据获取**：
```typescript
const overview = generateMonitoringOverview();
```

**展示数据**：
- `overview.cluster` - 集群信息
- `overview.nodes` - 节点统计
- `overview.indices` - 索引统计
- `overview.shards` - 分片统计
- `overview.jvm` - JVM 内存
- `overview.os` - 系统资源
- `overview.fs` - 磁盘空间

### 4.2 节点详情 (NodeDetail)

**文件位置**：`src/pages/NodeDetail/index.tsx`

**路由参数**：
```typescript
const { id } = useParams<{ id: string }>();
```

**数据获取**：
```typescript
const nodes = generateNodeStats();
const node = nodes[id];
const timeSeries = generateNodeTimeSeries(id, [
  'cpu_percent',
  'heap_used_percent',
  'disk_used_percent',
  'search_rate',
  'indexing_rate',
  'gc_young_count',
], startTime, endTime);
```

**时间范围**：
```typescript
interface TimeRange {
  label: string;
  value: number;  // 毫秒
}

const TIME_RANGES: TimeRange[] = [
  { label: '15分钟', value: 15 * 60 * 1000 },
  { label: '1小时', value: 60 * 60 * 1000 },
  { label: '6小时', value: 6 * 60 * 60 * 1000 },
  { label: '24小时', value: 24 * 60 * 60 * 1000 },
  { label: '7天', value: 7 * 24 * 60 * 60 * 1000 },
];
```

### 4.3 告警规则 (AlertRules)

**文件位置**：`src/pages/AlertRules/index.tsx`

**状态管理**：
```typescript
const [rules, setRules] = useState<AlertRule[]>([]);
const [modalVisible, setModalVisible] = useState(false);
const [editingRule, setEditingRule] = useState<AlertRule | null>(null);
```

**CRUD 操作**：
```typescript
// 创建规则
const handleCreate = (values: AlertRule) => {
  const newRule = { ...values, id: `rule-${Date.now()}`, createdAt: Date.now() };
  setRules([newRule, ...rules]);
};

// 更新规则
const handleUpdate = (id: string, values: Partial<AlertRule>) => {
  setRules(rules.map(r => r.id === id ? { ...r, ...values, updatedAt: Date.now() } : r));
};

// 删除规则
const handleDelete = (id: string) => {
  setRules(rules.filter(r => r.id !== id));
};

// 启用/禁用
const handleToggle = (id: string, enabled: boolean) => {
  handleUpdate(id, { enabled });
};
```

### 4.4 审批详情 (ApprovalDetail)

**文件位置**：`src/pages/ApprovalDetail/index.tsx`

**路由参数**：
```typescript
const { id } = useParams<{ id: string }>();
```

**数据获取**：
```typescript
const request = mockApprovalRequests.find(r => r.id === id);
const workflow = mockWorkflowInstances.find(w => w.approvalId === id);
const boundWorkflows = builtinWorkflowTemplates.filter(
  t => t.boundApprovalTypes?.includes(request.type)
);
```

**审批操作**：
```typescript
// 通过
const handleApprove = () => {
  // 更新审批状态
  // 如果绑定操作流，自动触发执行
  if (boundWorkflows.length > 0) {
    const newWorkflow = createWorkflowInstance(boundWorkflows[0], request.id);
    setWorkflow(newWorkflow);
  }
};

// 驳回
const handleReject = (comment: string) => {
  // 更新审批状态为 rejected
  // 记录驳回原因
};
```

### 4.5 操作流管理 (Workflows)

**文件位置**：`src/pages/Workflows/index.tsx`

**Tab 页**：
- `instances` - 操作流实例
- `templates` - 操作流模板
- `operations` - 原子操作
- `history` - 执行历史

**原子操作 CRUD**：
```typescript
const handleSaveOperation = async () => {
  const values = await operationForm.validateFields();
  const newOp: AtomicOperation = {
    id: editingOperation?.id || `op-${Date.now()}`,
    name: values.name,
    type: values.type,
    description: values.description,
    apiConfig: {
      method: values.method,
      endpoint: values.endpoint,
      body: values.body,
    },
    inputSchema: {},
    isBuiltin: false,
    createdAt: editingOperation?.createdAt || Date.now(),
    updatedAt: Date.now(),
  };
  // 保存到状态
};
```

**模板创建**：
```typescript
const handleSaveTemplate = async () => {
  const values = await templateForm.validateFields();
  const newTpl: WorkflowTemplate = {
    id: `tpl-${Date.now()}`,
    name: values.name,
    description: values.description,
    category: values.category,
    steps: values.steps.map(s => ({
      name: s.name,
      type: s.type,
      description: s.description,
      config: {},
    })),
    isBuiltin: false,
    createdAt: Date.now(),
    updatedAt: Date.now(),
  };
  // 保存到状态
};
```

**实例执行**：
```typescript
const handleCreateInstance = async () => {
  const values = await instanceForm.validateFields();
  const template = templates.find(t => t.id === values.templateId);
  
  const newInstance: WorkflowInstance = {
    id: `wf-${Date.now()}`,
    templateId: template.id,
    templateName: template.name,
    name: values.name,
    status: 'running',
    currentStepIndex: 0,
    progress: 0,
    triggerType: 'manual',
    variables: values.variables || {},
    steps: template.steps.map((s, i) => ({
      ...s,
      id: `s${i + 1}`,
      status: i === 0 ? 'running' : 'pending',
      startedAt: i === 0 ? Date.now() : undefined,
    })),
    createdBy: 'admin',
    createdAt: Date.now(),
    startedAt: Date.now(),
    updatedAt: Date.now(),
  };
  // 保存到状态
};
```

---

## 5. 通用组件

### 5.1 TimeRangeSelector - 时间范围选择器

**文件位置**：`src/components/TimeRangeSelector.tsx`

**Props**：
```typescript
interface TimeRangeSelectorProps {
  value: number;                       // 当前选中的时间范围（毫秒）
  onChange: (value: number) => void;   // 变更回调
}
```

**使用示例**：
```tsx
<TimeRangeSelector 
  value={timeRange} 
  onChange={setTimeRange} 
/>
```

### 5.2 MetricChart - 指标图表

**文件位置**：`src/components/MetricChart.tsx`

**Props**：
```typescript
interface MetricChartProps {
  title: string;                       // 图表标题
  data: TimeSeriesDataPoint[];         // 时序数据
  unit?: string;                       // 单位（如 %、ms）
  color?: string;                      // 线条颜色
  height?: number;                     // 图表高度
}
```

**使用示例**：
```tsx
<MetricChart
  title="CPU 使用率"
  data={cpuData}
  unit="%"
  color="#1890ff"
  height={200}
/>
```

---

## 6. 业务流程图

### 6.1 告警处理流程

```mermaid
flowchart TD
    A[指标采集] --> B{超过阈值?}
    B -->|否| A
    B -->|是| C{持续时间达到?}
    C -->|否| A
    C -->|是| D[创建告警记录]
    D --> E[查询通知渠道]
    E --> F[发送通知]
    F --> G[记录发送结果]
    G --> H{告警恢复?}
    H -->|是| I[更新状态为resolved]
    H -->|否| J{用户确认?}
    J -->|是| K[更新状态为acknowledged]
    J -->|否| H
```

### 6.2 审批-操作流集成流程

```mermaid
flowchart TD
    A[用户提交审批] --> B{选择申请类型}
    B --> C[查询绑定的操作流]
    C --> D{有绑定?}
    D -->|是| E[显示关联操作流]
    D -->|否| F[普通审批]
    E --> G[提交审批]
    F --> G
    G --> H[审批人审批]
    H -->|通过| I{有绑定操作流?}
    H -->|驳回| J[返回修改]
    I -->|是| K[自动创建操作流实例]
    I -->|否| L[手动执行]
    K --> M[执行步骤1]
    M --> N[执行步骤2]
    N --> O[...]
    O --> P{执行成功?}
    P -->|是| Q[更新审批状态为completed]
    P -->|否| R[更新审批状态为failed]
    Q --> S[发送通知]
    R --> S
```

### 6.3 操作流执行流程

```mermaid
flowchart TD
    A[创建操作流实例] --> B[初始化步骤状态]
    B --> C[获取当前步骤]
    C --> D[解析变量模板]
    D --> E[构建API请求]
    E --> F[执行API调用]
    F --> G{执行成功?}
    G -->|是| H[记录执行结果]
    G -->|否| I{重试次数<最大?}
    I -->|是| J[等待后重试]
    J --> F
    I -->|否| K[标记步骤失败]
    H --> L{有下一步?}
    K --> M[标记实例失败]
    L -->|是| N[更新进度]
    N --> C
    L -->|否| O[标记实例完成]
    O --> P[发送完成通知]
    M --> Q[发送失败通知]
```

---

## 7. 开发指南

### 7.1 添加新页面

1. 在 `src/pages/` 下创建页面目录和 `index.tsx`
2. 在 `src/pages/index.ts` 中导出
3. 在 `src/App.tsx` 中添加路由
4. 在 `src/layouts/MainLayout.tsx` 中添加菜单项

### 7.2 添加新类型

1. 在 `src/types/elasticsearch.ts` 中定义类型
2. 在 `src/types/index.ts` 中导出

### 7.3 添加 Mock 数据

1. 在对应的 `src/services/*MockData.ts` 中添加数据
2. 添加名称映射常量
3. 导出数据和函数

### 7.4 代码规范

- 使用 TypeScript 严格模式
- 组件使用函数式组件 + Hooks
- 中文注释
- 使用 Ant Design 组件
- 使用 Tailwind CSS 样式
- 文件命名：组件 PascalCase，其他 camelCase
